<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ğŸ“Œ êµìœ¡ê¸°ê°„í™•ì¸ ì„ íƒ ì¡°íšŒ</title>
  <style>
    :root{
      --bg:#070a14; --card:#0e1733; --muted:#a9b7d7; --text:#eef3ff;
      --accent:#7aa2ff; --danger:#ff6b6b; --border: rgba(122,162,255,.18);
      --tableHead: rgba(122,162,255,.14);
      --tableRow: rgba(255,255,255,.03);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
        linear-gradient(180deg, #050712, #070a14 30%, #050712);
      color: var(--text);
      padding-bottom: 84px;
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px; }
    h1{ margin: 0 0 6px; font-size: 18px; }
    .sub{ margin:0 0 14px; color: var(--muted); font-size: 12.5px; line-height:1.45; }
    .pill{
      display:inline-block; padding: 4px 9px; border-radius: 999px;
      border: 1px solid rgba(169,183,215,.2);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .card{
      background: rgba(14,23,51,.92);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      margin-bottom: 12px;
    }
    .card h2{ margin:0 0 10px; font-size: 13px; color:#dbe5ff; }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.22);
      background: rgba(4,8,18,.65);
      color: var(--text);
      padding: 11px 12px;
      outline: none;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,162,255,.75);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }
    .row{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 640px){ .row{ grid-template-columns: 1fr 1fr 1fr; } }
    .status{ margin-top: 10px; font-size: 12px; color: var(--muted); line-height:1.45; }
    .status b{ color: #dbe5ff; }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.5; margin-top:8px; }
    details{ border-radius: 14px; overflow: hidden; }
    details > summary{
      cursor: pointer;
      list-style: none;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.18);
      background: rgba(255,255,255,.04);
      color:#dbe5ff;
      font-weight: 800;
      font-size: 13px;
    }
    details > summary::-webkit-details-marker{ display:none; }
    .actionbar{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(6,10,20,.72);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(169,183,215,.14);
    }
    .actionbar .inner{ max-width: 980px; margin: 0 auto; display:flex; gap:10px; }
    button{
      border: 0;
      border-radius: 14px;
      padding: 12px 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
      flex:1;
    }
    .primary{ background: var(--accent); color:#061028; }
    .copy{ background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(169,183,215,.22); }
    .danger{ background: rgba(255,107,107,.14); color: #ffd5d5; border: 1px solid rgba(255,107,107,.35); flex: 0 0 auto; }

    /* Table */
    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.18);
      background: rgba(4,8,18,.35);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1250px;
    }
    thead th{
      position: sticky;
      top: 0;
      background: var(--tableHead);
      color: #e9efff;
      text-align: left;
      font-size: 13px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(169,183,215,.2);
      white-space: nowrap;
    }
    tbody td{
      font-size: 13.5px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(169,183,215,.12);
      background: rgba(255,255,255,.02);
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) td{ background: rgba(255,255,255,.03); }
    .countLine{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      margin: 6px 0 10px;
      color: var(--muted);
      font-size: 12.5px;
    }
    .countLine b{ color:#dbe5ff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .hide{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“Œ êµìœ¡ê¸°ê°„í™•ì¸ ì„ íƒ ì¡°íšŒ</h1>
    <p class="sub">
      >> ì‚¬ìš© ë°©ë²•<br/>
      <span class="pill">â‘  ë¶€ì„œì„ íƒ(1/2)</span>
      <span class="pill">â‘¡ êµìœ¡ê¸°ê°„í™•ì¸ ì„ íƒ</span>
      <span class="pill">â‘¢ ê°€ì ¸ì˜¤ê¸° & ìƒì„±</span>
      <span class="pill">â‘£ Copyë¡œ ë¶™ì—¬ë„£ê¸° / ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span>
    </p>

    <div class="card">
      <h2>ì„ íƒ</h2>
      <div class="row">
        <div>
          <label>ë¶€ì„œì„ íƒ</label>
          <select id="dept">
            <option value="1">1</option>
            <option value="2" selected>2</option>
          </select>
        </div>
        <div>
          <label>ë“±ë°˜ í™•ì¸</label>
          <select id="month">
                        <option value="__ALL__">ì „ì²´</option>
<option value="ë“±ë°˜">ë“±ë°˜</option>
            <option value="ë“±ë°˜ë³´ë¥˜">ë“±ë°˜ë³´ë¥˜</option>
            <option value="ë“±ë°˜ì˜ˆì •">ë“±ë°˜ì˜ˆì •</option>
            <option value="êµìœ¡ì¤‘(1)">êµìœ¡ì¤‘(1)</option>
            <option value="êµìœ¡ì¤‘(2)">êµìœ¡ì¤‘(2)</option>
          </select>
        </div>
        <div>
          <label>ì˜µì…˜</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:2px;">
            <label style="margin:0; display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;">
              <input type="checkbox" id="optAutoCopy" style="width:auto; transform: scale(1.1);" />
              ìƒì„± í›„ ìë™ Copy (TSV)
            </label>
          </div>
        </div>
      </div>
      <div class="status" id="status"></div>
    </div>

    <div class="card">
      <h2>ê²°ê³¼</h2>
      <div class="countLine">
        <div>ì„ íƒ ê°’: <b id="pickedValue">-</b></div>
        <div>ì¸ì›: <b id="pickedCount">0</b>ëª…</div>
      </div>

      <div class="tableWrap">
        <table id="resultTable" aria-label="result">
          <thead>
            <tr>
              <th>ì˜ˆê¼¬ ì´ë¦„</th>
              <th>ì„±ë³„</th>
              <th>ì„ì‹œë°˜ëª…</th>
              <th>ìƒë…„ì›”ì¼</th>
              <th>ì£¼ë³´í˜¸ì</th>
              <th>ë³´í˜¸ìì—°ë½ì²˜</th>
              <th>ì£¼ì†Œ</th>
              <th>ë“±ë¡ì¼</th>
              <th>ë“±ë°˜ í™•ì¸</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" style="color:rgba(169,183,215,.9);">ê°€ì ¸ì˜¤ê¸° &amp; ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Copy ìš© TSV(ìˆ¨ê¹€) -->
      <textarea id="copyBuffer" class="hide"></textarea>

      <div class="hint">
        â€¢ í•„í„° ê¸°ì¤€: Bì—´(ë¶€ì„œ=1/2) + Nì—´(ë“±ë°˜ í™•ì¸)ì´ ì„ íƒê°’ê³¼ ì¼ì¹˜í•˜ëŠ” í–‰<br/>
        â€¢ ì¶œë ¥ ì»¬ëŸ¼: F~O (ì˜ˆê¼¬ ì´ë¦„~ë¹„ê³ ) / ì •ë ¬: H(ë‚´ë¦¼ì°¨ìˆœ) â†’ F(ì˜¬ë¦¼ì°¨ìˆœ)<br/>
        â€¢ ê°œì¸ì •ë³´(ì—°ë½ì²˜ ë“±)ëŠ” ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    </div>

    <div class="card">
      <h2>ì„¤ì • (ìµœì´ˆ 1íšŒ)</h2>
      <details open>
        <summary>ì‹œíŠ¸ ë§í¬ ì„¤ì •</summary>
        <div style="padding-top:10px;">
          <label>Google Sheets ë§í¬</label>
          <input id="linkSheet" placeholder="https://docs.google.com/spreadsheets/d/..." />

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="primary" type="button" id="btnSave" style="flex:1;">ì„¤ì • ì €ì¥</button>
            <button class="copy" type="button" id="btnLoad" style="flex:1;">ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="danger" type="button" id="btnReset">ì´ˆê¸°í™”</button>
          </div>

          <div class="hint">
            â€¢ ì‹œíŠ¸ëŠ” â€œê³µìœ : ë§í¬ ìˆëŠ” ì‚¬ìš©ì ë³´ê¸°â€ ìƒíƒœì—¬ì•¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.<br/>
                        â€¢ ë§í¬ì˜ gidê°€ íŠ¹ì • ì‹œíŠ¸ë¥¼ ê°€ë¦¬í‚¤ë©´ ê·¸ ì‹œíŠ¸ì—ì„œ ë°”ë¡œ ì½ìŠµë‹ˆë‹¤.
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="actionbar">
    <div class="inner">
      <button class="primary" id="btnFetch" type="button">ê°€ì ¸ì˜¤ê¸° &amp; ìƒì„±</button>
      <button class="copy" id="btnExcel" type="button">ì—‘ì…€(.xlsx) ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const LS_KEY = "edu_period_confirm_tool_v1";

    
    // âœ… 1ì¤„ ì„¤ì •: ë§¤ë…„ ìƒˆ ì‹œíŠ¸ ë§í¬ë§Œ ì—¬ê¸°ë§Œ ë°”ê¿”ì£¼ì„¸ìš”.
    const SHEET_LINK = "https://docs.google.com/spreadsheets/d/16VS2GB8oje618-CqKB7SM4fj0x3nklE9/edit?gid=275581885#gid=275581885";
const DEFAULT_LINKS = {
      dept: "2",
      linkSheet1: SHEET_LINK,
      linkSheet2: SHEET_LINK
    };

    function ensureDefaultLinks(){
      const deptEl = $("dept");
      const linkEl = $("linkSheet");

      const dept = (deptEl && String(deptEl.value||"").trim()) || DEFAULT_LINKS.dept || "2";
      const link = (dept === "1") ? DEFAULT_LINKS.linkSheet1 : DEFAULT_LINKS.linkSheet2;

      if(deptEl && String(deptEl.value||"").trim() === "" && DEFAULT_LINKS.dept){
        deptEl.value = DEFAULT_LINKS.dept;
      }

      if(linkEl){
        linkEl.value = link;
      }
    }

    function escapeHtml(str=""){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function setStatus(msg, isError=false){
      const el = $("status");
      el.innerHTML = isError ? `âš ï¸ <b>${escapeHtml(msg)}</b>` : `âœ… <b>${escapeHtml(msg)}</b>`;
      el.style.color = isError ? "rgba(255,160,160,.95)" : "rgba(180,210,255,.95)";
    }

    function getSettings(){ return { dept: $("dept").value, linkSheet: $("linkSheet").value.trim() }; }
    function applySettings(s){ if(s.dept) $("dept").value = s.dept; $("linkSheet").value = s.linkSheet || ""; }
    function saveSettings(){
      localStorage.setItem(LS_KEY, JSON.stringify(getSettings()));
      setStatus("ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
    }
    function loadSettings(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ applySettings({}); setStatus("ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤."); return; }
      try{ applySettings(JSON.parse(raw)); setStatus("ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); }
      catch(e){ applySettings({}); setStatus("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨(ì €ì¥ê°’ ì†ìƒ).", true); }
    }
    function resetSettings(){
      localStorage.removeItem(LS_KEY);
      applySettings({});
      setStatus("ì„¤ì •ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    }

    // --- Google Sheets JSONP (CORS íšŒí”¼)
    function parseSheetLink(link){
      if(!link) return null;
      const m = link.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if(!m) return null;
      const id = m[1];
      const gidM = link.match(/gid=([0-9]+)/);
      const gid = gidM ? gidM[1] : null;
      return { id, gid };
    }

    function jsonp(url, { timeoutMs = 15000 } = {}){
      return new Promise((resolve, reject) => {
        const cb = "__bm_cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("ì‹œê°„ ì´ˆê³¼: ì‹œíŠ¸ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤(ê³µìœ  ì„¤ì •/ë„¤íŠ¸ì›Œí¬ í™•ì¸)."));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cb]; }catch(_){}
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("ë¡œë“œ ì‹¤íŒ¨: ì‹œíŠ¸ê°€ ë¹„ê³µê°œì´ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬/CORS ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤(ê³µìœ : ë§í¬ ë³´ê¸° í•„ìš”).")); };

        const joiner = url.includes("?") ? "&" : "?";
        script.src = url + joiner + "tqx=" + encodeURIComponent(`out:json;responseHandler:${cb}`);
        document.head.appendChild(script);
      });
    }

    async function fetchSheetTable(link){
      const info = parseSheetLink(link);
      if(!info) throw new Error("ì‹œíŠ¸ ë§í¬ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      // gidê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‹œíŠ¸ë¡œ
      const gidParam = info.gid ? `gid=${encodeURIComponent(info.gid)}` : "";
      const base = `https://docs.google.com/spreadsheets/d/${info.id}/gviz/tq?${gidParam}`;

      const data = await jsonp(base);
      if(!data || !data.table) throw new Error("ì‹œíŠ¸ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤(ê³µìœ  ì„¤ì • í™•ì¸: ë§í¬ ìˆëŠ” ì‚¬ìš©ì ë³´ê¸°).");

      const headers = (data.table.cols || []).map(c => (c.label || "").trim() || "");
      const rows = (data.table.rows || []).map(r => (r.c || []).map(cell => cell ? (cell.f ?? cell.v ?? "") : ""));
      return { headers, rows };
    }

    function findCol(headers, patterns){
      const hs = (headers || []).map(h => String(h||"").trim());
      for(let i=0;i<hs.length;i++){
        const h = hs[i].toLowerCase();
        for(const p of patterns){
          if(p.test(h)) return i;
        }
      }
      return -1;
    }

    function parseMonthNumber(v){
      const s = String(v ?? "").trim();
      // 1, 01, 1ì›”, " 1 ", etc.
      const m = s.match(/(\d{1,2})/);
      if(!m) return null;
      const n = parseInt(m[1], 10);
      return (n >= 1 && n <= 12) ? n : null;
    }

    function clearBody(){
      const tb = $("tbody");
      tb.innerHTML = "";
    }

    function renderTable(rows){
      const tb = $("tbody");
      tb.innerHTML = "";
      if(!rows.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 10;
        td.textContent = "í•´ë‹¹ ê°’ ë°ì´í„° ì—†ìŒ";
        td.style.color = "rgba(169,183,215,.9)";
        tr.appendChild(td);
        tb.appendChild(tr);
        return;
      }
      for(const r of rows){
        const tr = document.createElement("tr");
        for(const val of r){
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
    }

    function buildTSV(rows){
      const header = ["ì˜ˆê¼¬ ì´ë¦„","ì„±ë³„","ì„ì‹œë°˜ëª…","ìƒë…„ì›”ì¼","ì£¼ë³´í˜¸ì","ë³´í˜¸ìì—°ë½ì²˜","ì£¼ì†Œ","ë“±ë¡ì¼","ë“±ë°˜ í™•ì¸","ë¹„ê³ "];
      const lines = [header.join("\t")];
      for(const r of rows){
        lines.push(r.map(x => String(x ?? "")).join("\t"));
      }
      return lines.join("\n");
    }

    async function copyToClipboard(text){
      if(!String(text||"").trim()) throw new Error("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = $("copyBuffer");
        ta.classList.remove("hide");
        ta.value = text;
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.classList.add("hide");
        if(!ok) throw e;
        return true;
      }
    }

    async function handleFetch(){
      const selected = String(($("month").value||"").trim()); // êµìœ¡ê¸°ê°„í™•ì¸(Mì—´) ì„ íƒê°’
      const autoCopy = $("optAutoCopy").checked;
      const dept = String(($("dept") && $("dept").value) || "2").trim(); // Bì—´(ë¶€ì„œ)
      const link = (dept === "1") ? DEFAULT_LINKS.linkSheet1 : DEFAULT_LINKS.linkSheet2;

      // ë§í¬ ì…ë ¥ì¹¸ë„ ë™ê¸°í™”
      if($("linkSheet")) $("linkSheet").value = link;

      $("pickedValue").textContent = (selected === "__ALL__" ? "ì „ì²´" : (selected || "-"));
      $("pickedCount").textContent = "0";
      clearBody();

      if(!selected){ setStatus("ë“±ë°˜ í™•ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", true); return; }
      if(!link){ setStatus("ì‹œíŠ¸ ë§í¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤(ì„¤ì •ì—ì„œ ì…ë ¥).", true); return; }

      setStatus("ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

      try{
        const table = await fetchSheetTable(link);
        const headers = table.headers || [];
        const rows = table.rows || [];

        // í—¤ë”ê°€ ìˆì–´ë„, ì´ ì‹œíŠ¸ëŠ” ê³ ì • ì»¬ëŸ¼ì´ë¼ A=0 ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
                const colDept = 1;  // B ë¶€ì„œ
        const colF = 5;     // F ì˜ˆê¼¬ ì´ë¦„
        const colG = 6;     // G ì„±ë³„
        const colH = 7;     // H ì„ì‹œë°˜ëª…
        const colI = 8;     // I ìƒë…„ì›”ì¼
        const colJ = 9;     // J ì£¼ë³´í˜¸ì
        const colK = 10;    // K ë³´í˜¸ìì—°ë½ì²˜
        const colL = 11;    // L ì£¼ì†Œ
        const colM = 12;    // M ë“±ë¡ì¼
        const colN = 13;    // N ë“±ë°˜ í™•ì¸
        const colO = 14;    // O ë¹„ê³ 

        const filtered = [];
        for(const r of rows){
          if(!r || !r.some(v => String(v||"").trim() !== "")) continue;

          const rDept = String(r[colDept] ?? "").trim();
          if(rDept !== dept) continue;

                              const rStatus = String(r[colN] ?? "").trim();
          if(selected !== "__ALL__" && rStatus !== selected) continue;

                    const out = [
            String(r[colF] ?? "").trim(),
            String(r[colG] ?? "").trim(),
            String(r[colH] ?? "").trim(),
            String(r[colI] ?? "").trim(),
            String(r[colJ] ?? "").trim(),
            String(r[colK] ?? "").trim(),
            String(r[colL] ?? "").trim(),
            String(r[colM] ?? "").trim(),
            String(r[colN] ?? "").trim(),
            String(r[colO] ?? "").trim(),
          ];
          if(!out[0]) continue;
          filtered.push(out);
        }
        // ì •ë ¬ ì—†ìŒ: ì‹œíŠ¸ ì›ë³¸ ìˆœì„œ ìœ ì§€
renderTable(filtered);
        $("pickedCount").textContent = String(filtered.length);

        const tsv = buildTSV(filtered);
        $("copyBuffer").value = tsv;

        setStatus(`ìƒì„± ì™„ë£Œ: ${filtered.length}ëª…`);

        if(autoCopy){
          await copyToClipboard(tsv);
          setStatus(`ìƒì„± ì™„ë£Œ + ìë™ Copy (${filtered.length}ëª…)`);
        }
      }catch(e){
        clearBody();
        const tb = $("tbody");
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 10;
        td.textContent = "ì˜¤ë¥˜: " + (e.message || String(e));
        td.style.color = "rgba(255,160,160,.95)";
        tr.appendChild(td);
        tb.appendChild(tr);
        setStatus(e.message || String(e), true);
      }
    }

    async function handleExcel(){
      try{
        const tsv = $("copyBuffer").value;
        if(!String(tsv||"").trim()){
          setStatus("ë‹¤ìš´ë¡œë“œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê°€ì ¸ì˜¤ê¸° & ìƒì„± ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", true);
          return;
        }
        if(typeof XLSX === "undefined"){
          setStatus("ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤(ë„¤íŠ¸ì›Œí¬/ì°¨ë‹¨ ì„¤ì • í™•ì¸).", true);
          return;
        }

        // TSV -> AOA
        const lines = tsv.split(/\r?\n/).filter(l => l !== "");
        const aoa = lines.map(line => line.split("\t"));

        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();

        const month = String($("month").value || "").trim();
        const monthLabel = (month === "__ALL__") ? "ì „ì²´" : month;
        const sheetName = `ë“±ë°˜í™•ì¸_${monthLabel}`;
        XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0, 31));

        const filename = `ë“±ë°˜í™•ì¸_${monthLabel}_ëª…ë‹¨.xlsx`;
        XLSX.writeFile(wb, filename);
        setStatus("ì—‘ì…€(.xlsx) íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        setStatus("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: " + (e.message || String(e)), true);
      }
    }



    async function handleCopy(){
      try{
        const text = $("copyBuffer").value;
        await copyToClipboard(text);
        setStatus("í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤ (TSV).");
      }catch(e){
        setStatus("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œ/ë³´ì•ˆ(HTTPS) í™•ì¸", true);
      }
    }

    $("btnFetch").addEventListener("click", handleFetch);
    $("btnExcel").addEventListener("click", handleExcel);
    $("btnSave").addEventListener("click", () => saveSettings());
    $("btnLoad").addEventListener("click", () => { loadSettings(); ensureDefaultLinks(); });
    $("btnReset").addEventListener("click", () => { resetSettings(); ensureDefaultLinks(); });
    $("dept").addEventListener("change", () => {
      const dept = String($("dept").value || "2");
      const link = (dept === "1") ? DEFAULT_LINKS.linkSheet1 : DEFAULT_LINKS.linkSheet2;
      $("linkSheet").value = link;
      // ë¶€ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥(ë§í¬ê°€ ì•ˆ ì €ì¥ë˜ëŠ” ë¬¸ì œ ë°©ì§€)
      try{ saveSettings(); }catch(_e){}
      setStatus("ë¶€ì„œ ì„ íƒ ë³€ê²½: " + dept);
    });

    // default month = í˜„ì¬ ì›”
    (function initDefault(){
      // ê¸°ë³¸ê°’: ì²« ì˜µì…˜
      const sel = $("month");
      if(sel && sel.options && sel.options.length) sel.selectedIndex = 0;
      const v = (sel && sel.value) ? sel.value : "";
      $("pickedValue").textContent = (v === "__ALL__") ? "ì „ì²´" : (v || "-");
    })();

    loadSettings();
    ensureDefaultLinks();
  </script>
</body>
</html>
